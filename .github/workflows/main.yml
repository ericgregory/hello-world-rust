name: Build Wasm component from Rust and push to OCI registry

on: [release]

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
     - uses: actions/checkout@v4
     
     - name: Setup wash CLI
       uses: cosmonic-labs/setup-wash-action@main
       with:
         wash-version: latest

     - name: Install wasm32-wasip2 target for Rust
       run: |
          rustup target add wasm32-wasip2

     - name: Compile Wasm binary
       run: |
          wash build

     - name: Get Wasm binary filename
       run: |
          WASM_FILENAME="$(basename ./target/wasm32-wasip2/debug/*.wasm .wasm)"
          echo "GITHUB_WASM_FILENAME=${WASM_FILENAME}" >>${GITHUB_ENV}

     - name: Login to GHCR
       uses: docker/login-action@v3
       with:
         registry: ghcr.io
         username: ${{ github.repository_owner }}
         password: ${{ secrets.GITHUB_TOKEN }}

     - name: Lowercase the organization name for ghcr.io
       run: |
          echo "GHCR_REPO_NAMESPACE=${GITHUB_REPOSITORY_OWNER,,}" >>${GITHUB_ENV}

     - name: Lowercase the repository name
       run: |
          REPO_NAME=${{ github.event.repository.name }}
          echo "GHCR_REPO_NAME=${REPO_NAME,,}" >>${GITHUB_ENV}

     - name: Push Wasm component to ghcr.io
       working-directory: ./target/wasm32-wasip2/debug/
       run: |
          wash oci push ghcr.io/${{ env.GHCR_REPO_NAMESPACE }}/components/${{ env.GHCR_REPO_NAME }}:${{ github.ref_name }} ./${{ env.GITHUB_WASM_FILENAME }}.wasm